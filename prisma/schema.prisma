generator client {
  provider = "prisma-client-js"
}

generator kysely {
  provider     = "prisma-kysely"
  output       = "../types"
  fileName     = "db-types.ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  MANAGER
  STAFF
}

enum TransactionType {
  SALE
  RESTOCK
  ADJUST
  TRANSFER
}

// Models
model User {
  id           String        @id @default(uuid())
  email        String        @unique
  password     String        // Hashed password
  name         String
  role         Role          @default(STAFF)
  branchId     String?
  branch       Branch?       @relation(fields: [branchId], references: [id])
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Branch {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  location     String?
  users        User[]
  stocks       Stock[]
  transactions Transaction[] // Transactions originating from this branch
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Category {
  id        String    @id @default(uuid())
  code      String    @unique
  name      String
  products  Product[]
}

model Product {
  id               String            @id @default(uuid())
  sku              String            @unique
  name             String
  description      String?
  imageUrl         String?
  unit             String            @default("ชิ้น")
  basePrice        Decimal           @db.Decimal(10, 2)
  costPrice        Decimal           @db.Decimal(10, 2) @default(0)
  categoryId       String
  category         Category          @relation(fields: [categoryId], references: [id])
  stocks           Stock[]
  transactionItems TransactionItem[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Stock {
  id           String  @id @default(uuid())
  branchId     String
  productId    String
  quantity     Int     @default(0)
  reorderPoint Int     @default(10)
  branch       Branch  @relation(fields: [branchId], references: [id])
  product      Product @relation(fields: [productId], references: [id])

  @@unique([branchId, productId])
}

model Transaction {
  id          String            @id @default(uuid())
  type        TransactionType
  branchId    String
  branch      Branch            @relation(fields: [branchId], references: [id])
  totalAmount Decimal           @db.Decimal(10, 2)
  items       TransactionItem[]
  createdById String
  createdBy   User              @relation(fields: [createdById], references: [id])
  note        String?
  createdAt   DateTime          @default(now())
}

model TransactionItem {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  quantity      Int
  unitPrice     Decimal     @db.Decimal(10, 2)
  subtotal      Decimal     @db.Decimal(10, 2)
}
